(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const u of r.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&s(u)}).observe(document,{childList:!0,subtree:!0});function o(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=o(n);fetch(n.href,r)}})();const g={userId:"",partnerId:""},f=()=>g,L=(e,t)=>{g.userId=e,g.partnerId=t},c=e=>document.querySelector(e),v=c("#messageForm");c("#messageInput");const E=c("#userIdInput"),$=c("#partnerIdInput"),O=c("#loginForm"),T=c("#loginContainer"),b=c(".chat-container"),a=c("#messageList");function I(e){e.scrollTop=e.scrollHeight}function M(){if(c(".unread-separator"))return;const e=document.createElement("li");e.className="unread-separator",e.textContent="Mensajes sin leer",a.appendChild(e)}function C(e){return e.scrollHeight-e.scrollTop<=e.clientHeight+2}function y(e){const o=new Date(e.timestamp).toLocaleString("es-ES",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"}),{userId:s}=f(),n=s===e.userId,r=document.createElement("li");return r.classList.add("message",n?"user":"partner"),r.innerHTML=`
		<header>
			<span class="message-user">${e.userId}</span>
			<span class="message-date">${o}</span>
		</header>
		<span class="message-content">${e.content}</span>
	`,r}const H="ws://localhost:3000";var l=(e=>(e.CHAT="chat",e.USER_JOINED="user_joined",e.USER_LEFT="user_left",e))(l||{});const N=e=>{const t=y(e);U(e)||C(a)?I(a):M(),a.appendChild(t)};function U(e){return e.userId===f().userId}const D=e=>{a.innerHTML="";for(const t of e.messages){const o=y(t);a.appendChild(o)}I(a)},h={[l.CHAT]:N,[l.USER_JOINED]:D},_=e=>{if(!e||!e.type){console.error("Mensaje invÃ¡lido:",e);return}if(!(e.type in h)){console.error(`Tipo de mensaje desconocido: ${e.type}`);return}"messages"in e&&typeof e.messages=="string"&&(e.messages=JSON.parse(e.messages));const t=h[e.type];t&&t(e)};let i=null,d=null,p=5;function w(e,t){i=new WebSocket(H);let{userId:o,partnerId:s}=f();if(o||=e||"",s||=t||"",!o||!s)throw console.log({userId:o,partnerId:s}),new Error("Both userId and partnerId must be set");L(o,s),i.onopen=()=>{console.log("Socket connected!"),d&&(clearTimeout(d),d=null),S({type:l.USER_JOINED,userId:o,partnerId:s}),p=5},i.onmessage=n=>{let r;try{r=JSON.parse(n.data)}catch{console.error("No se pudo parsear el mensaje:",n.data);return}_(r)},i.onclose=()=>{console.log("Disconnected from the server"),F()},i.onerror=n=>{console.error("WebSocket error:",n)}}const S=e=>{if(!i)throw new Error("Socket is not connected");if(!e)throw new Error("Message cannot be empty");if(!("type"in e))throw new Error("Message must have a type");if(!Object.values(l).includes(e.type))throw new Error(`Invalid message type: ${e.type}`);const{userId:t,partnerId:o}=f();if(!t||!o)throw new Error("User ID and Partner ID must be set");e.userId=t,e.partnerId=o,i.send(JSON.stringify(e))};function F(){if(console.log(`Reconnecting to ws (${p})...`),p<=0){console.error("Max reconnect attempts reached");return}d=setTimeout(()=>{w(),d=null,p--},1e3*2)}const J=e=>{e.preventDefault();const t=E.value.trim(),o=$.value.trim();w(t,o),T.style.display="none",b.style.display="flex"},m=c("#messageInput"),j=e=>{e.preventDefault();const t={type:l.CHAT,content:m.value.trim()};S(t),m.value="",m.focus()};O.addEventListener("submit",J);v.addEventListener("submit",j);
